name: Build and Release FnNAS

on:
  workflow_dispatch:
    inputs:
      DEVICE:
        description: "æ„å»ºæŒ‡å®šè®¾å¤‡ï¼ˆç•™ç©ºåˆ™æ„å»ºæ‰€æœ‰ uboot/* è®¾å¤‡ï¼‰"
        required: false
        default: ""
      ROOT_SIZE:
        description: "rootfs æ‰©å®¹å¤§å°ï¼ˆGiBï¼Œé»˜è®¤ 6ï¼‰"
        required: false
        default: "6"

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare device matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate release tag
        id: set-tag
        run: |
          echo "tag=fnos_$(date +%Y%m%d)" >> "$GITHUB_OUTPUT"

      - name: Generate device matrix
        id: set-matrix
        run: |
          set -e
          INPUT_DEVICE="${{ github.event.inputs.DEVICE }}"
          if [ -n "$INPUT_DEVICE" ]; then
            if [ ! -d "uboot/$INPUT_DEVICE" ]; then
              echo "âŒ Device not found: $INPUT_DEVICE"
              exit 1
            fi
            DEVICES="[\"$INPUT_DEVICE\"]"
          else
            DEVICES=$(ls -1 uboot | jq -R -s -c 'split("\n")[:-1]')
          fi
          echo "matrix={\"device\":$DEVICES}" >> "$GITHUB_OUTPUT"

      - name: List all devices for release
        id: all-devices
        run: |
          ALL_DEVICES=$(ls -1 uboot | tr '\n' ',' | sed 's/,$//')
          echo "all_devices=$ALL_DEVICES" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.device }}
    needs: prepare
    runs-on: ubuntu-latest
    continue-on-error: true       # å•è®¾å¤‡å¤±è´¥ä¸å½±å“å…¶ä»–è®¾å¤‡
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout private buildfnos.sh repo
        uses: actions/checkout@v4
        with:
          repository: mingxiaoyu/actionbuild
          token: ${{ secrets.GH_TOKEN }}
          path: actionbuild

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq xz-utils

      - name: Download Latest Rockchip FnNAS Image
        id: download
        run: |
          set -e
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          API_URL="https://api.github.com/repos/$REPO/releases/tags/$TAG"
          RESPONSE=$(curl -sL "$API_URL")
          ASSET_URL=$(echo "$RESPONSE" | jq -r '
            .assets[] | select(.name | test("rockchip") and endswith(".img.xz")) | .browser_download_url
          ' | sort -V | tail -n 1)
          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" = "null" ]; then
            echo "âŒ No Rockchip .img.xz asset found"
            exit 1
          fi
          FILENAME=$(basename "$ASSET_URL")
          curl -L -o "$FILENAME" "$ASSET_URL"
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"

      - name: Decompress base image
        run: |
          mkdir -p fnnas-arm64
          xz -d -c "${{ steps.download.outputs.filename }}" > fnnas-arm64/fnnas-arm64.img

      - name: Build device image
        env:
          DEVICE: ${{ matrix.device }}
          ROOT_SIZE: ${{ github.event.inputs.ROOT_SIZE }}
        run: |
          mkdir -p build-logs
          bash actionbuild/buildfnos.sh &> build-logs/${{ matrix.device }}.log || true

      - name: Upload private build logs
        uses: actions/upload-artifact@v4
        with:
          name: private-build-logs-${{ matrix.device }}-${{ github.run_number }}
          path: build-logs/

      - name: Compress built image
        run: |
          mkdir -p out-compressed
          for f in out/*.img; do
            xz -T0 -z -9 -c "$f" > "out-compressed/$(basename "$f").xz"
          done

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          files: out-compressed/*.img.xz
          body: |
            ğŸ‰ åŸºäº FNOS ARM é•œåƒäºŒæ¬¡æ‰“åŒ…
            æ ¹ç›®å½•é»˜è®¤å¤§å°: ${{ github.event.inputs.ROOT_SIZE }} GiB
            æ”¯æŒè®¾å¤‡: ${{ needs.prepare.outputs.all_devices }}
          
            ğŸ‰ FNOS ARM re-packaged image
            Default root size: ${{ github.event.inputs.ROOT_SIZE }} GiB
            Supported devices: ${{ needs.prepare.outputs.all_devices }}
